<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geoportal Algarrobo | Plataforma de Datos Geoespaciales</title>

    <!-- Leaflet CSS (Última versión) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>

    <!-- Leaflet Draw CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    
    <!-- Leaflet Measure CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-measure/3.1.0/leaflet-measure.css"/>
    
    <!-- Leaflet Search CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-search/3.0.0/leaflet-search.min.css"/>

    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- AOS para animaciones de entrada -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

    <style>
        /* --- Variables de Diseño (Nueva Paleta de Colores) --- */
        :root {
            --primary-color: #007B5E;
            --secondary-color: #006644;
            --accent-color: #005C4A;
            --accent2-color: #C70039;
            --ocean-blue: #006994;
            --nature-green: #2E7D32;
            --earth-brown: #795548;
            --sunset-orange: #FF9800;
            --sunset-purple: #9C27B0;
            --text-color: #333333;
            --light-gray: #F0F0F0;
            --dark-gray: #444444;
            --white: #ffffff;
            --border-radius: 16px;
            --transition-speed: 0.3s;
        }

        /* --- Estilos Generales y Reset --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--white);
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        h1, h2, h3 {
            font-weight: 700;
            line-height: 1.2;
            margin-bottom: 1.5rem;
        }

        h1 {
            font-size: 3.5rem;
            color: var(--white);
            text-shadow: 2px 2px 8px rgba(0,0,0,0.7);
        }

        h2 {
            font-size: 2.5rem;
            color: var(--primary-color);
        }

        h3 {
            font-size: 1.5rem;
            color: var(--secondary-color);
        }

        a {
            text-decoration: none;
            color: var(--primary-color);
            transition: color var(--transition-speed) ease;
        }

        a:hover {
            color: var(--accent-color);
        }

        /* --- Hero Section Animado --- */
        .hero-section {
            position: relative;
            height: 100vh;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)), 
                        url('https://picsum.photos/seed/algarrobo-beach/1920/1080.jpg') no-repeat center center;
            background-size: cover;
            z-index: 1;
        }

        .hero-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(0, 123, 94, 0.7), rgba(0, 105, 148, 0.7));
            z-index: -1;
            animation: gradientShift 10s ease infinite;
        }

        @keyframes gradientShift {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 0.5; }
        }

        .hero-content {
            text-align: center;
            color: var(--white);
            z-index: 2;
            padding: 0 20px;
        }

        .hero-title {
            font-size: 4rem;
            font-weight: 800;
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .typewriter {
            display: inline-block;
            border-right: 3px solid var(--white);
            animation: typing 3.5s steps(30, end), blink-caret 0.75s step-end infinite;
            white-space: nowrap;
            overflow: hidden;
        }

        @keyframes typing {
            from { width: 0 }
            to { width: 100% }
        }

        @keyframes blink-caret {
            from, to { border-color: transparent }
            50% { border-color: var(--white); }
        }

        .hero-subtitle {
            font-size: 1.5rem;
            margin-bottom: 2rem;
            opacity: 0;
            animation: fadeInUp 1s ease 3.5s forwards;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .hero-cta {
            display: inline-block;
            padding: 15px 30px;
            background-color: var(--accent2-color);
            color: var(--white);
            font-weight: 600;
            border-radius: 50px;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all var(--transition-speed) ease;
            box-shadow: 0 4px 15px rgba(199, 0, 57, 0.3);
            opacity: 0;
            animation: fadeInUp 1s ease 4s forwards;
            position: relative;
            overflow: hidden;
        }

        .hero-cta:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 20px rgba(199, 0, 57, 0.4);
        }

        .ripple {
            position: absolute;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.5);
            transform: scale(0);
            animation: ripple-animation 0.6s ease-out;
        }

        @keyframes ripple-animation {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        .scroll-indicator {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateX(-50%) translateY(0);
            }
            40% {
                transform: translateX(-50%) translateY(-10px);
            }
            60% {
                transform: translateX(-50%) translateY(-5px);
            }
        }

        /* --- Header con Glassmorphism --- */
        .main-header {
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
            width: 100%;
            transition: all var(--transition-speed) ease;
        }

        .main-header.scrolled {
            background-color: rgba(255, 255, 255, 0.85);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .main-header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 20px;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .logo i {
            margin-right: 10px;
            font-size: 2rem;
        }

        .logo-subtitle {
            font-size: 0.9rem;
            font-weight: 400;
            color: var(--dark-gray);
            margin-top: -5px;
        }

        .main-nav ul {
            display: flex;
            list-style: none;
        }

        .main-nav ul li {
            margin-left: 30px;
            position: relative;
        }

        .main-nav a {
            font-weight: 600;
            color: var(--dark-gray);
            font-size: 1.1rem;
            position: relative;
            padding-bottom: 5px;
        }

        /* Animación subrayado deslizante */
        .main-nav a::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background-color: var(--primary-color);
            transition: width var(--transition-speed) ease;
        }

        .main-nav a:hover::after {
            width: 100%;
        }

        .menu-toggle {
            display: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--primary-color);
        }

        /* --- Breadcrumbs Visuales --- */
        .breadcrumbs {
            position: absolute;
            top: 90px;
            left: 20px;
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            padding: 10px 15px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 997;
            display: flex;
            align-items: center;
            font-size: 0.9rem;
        }

        .breadcrumb-item {
            display: flex;
            align-items: center;
        }

        .breadcrumb-item:not(:last-child)::after {
            content: '›';
            margin: 0 8px;
            color: var(--dark-gray);
        }

        .breadcrumb-link {
            color: var(--primary-color);
            font-weight: 500;
        }

        .breadcrumb-current {
            color: var(--dark-gray);
            font-weight: 600;
        }

        .zoom-indicator {
            display: flex;
            align-items: center;
            margin-left: 15px;
            padding-left: 15px;
            border-left: 1px solid var(--light-gray);
        }

        .zoom-level {
            width: 100px;
            height: 6px;
            background-color: var(--light-gray);
            border-radius: 3px;
            margin-left: 8px;
            position: relative;
            overflow: hidden;
        }

        .zoom-fill {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background-color: var(--primary-color);
            border-radius: 3px;
            transition: width var(--transition-speed) ease;
        }

        /* --- Contenedor Principal del Mapa --- */
        .map-container {
            position: relative;
            height: calc(100vh - 90px);
            width: 100%;
            overflow: hidden;
        }

        #map {
            height: 100%;
            width: 100%;
            z-index: 1;
        }

        /* Asegurar que los controles de Leaflet sean visibles */
        .leaflet-control-container {
            z-index: 999;
        }

        .leaflet-top {
            top: 80px !important;
        }

        .leaflet-right {
            right: 360px !important;
        }

        /* --- Panel de Control de Capas --- */
        .layers-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 320px;
            max-height: 70vh;
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            z-index: 998;
            overflow: hidden;
            transition: all var(--transition-speed) ease;
            transform: translateX(0);
            opacity: 1;
        }

        .layers-panel.collapsed {
            width: 50px;
            height: 50px;
            max-height: 50px;
        }

        .panel-header {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: var(--white);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .panel-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .panel-toggle {
            font-size: 1.2rem;
            transition: transform var(--transition-speed) ease;
        }

        .layers-panel.collapsed .panel-toggle {
            transform: rotate(180deg);
        }

        .panel-content {
            padding: 15px;
            max-height: calc(70vh - 60px);
            overflow-y: auto;
        }

        .layers-panel.collapsed .panel-content {
            display: none;
        }

        .layer-group {
            margin-bottom: 20px;
        }

        .layer-group-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .layer-group-title i {
            margin-right: 8px;
            transition: transform var(--transition-speed) ease;
        }

        .layer-group.collapsed .layer-group-title i {
            transform: rotate(-90deg);
        }

        .layer-group-content {
            padding-left: 20px;
        }

        .layer-group.collapsed .layer-group-content {
            display: none;
        }

        .layer-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 8px;
            transition: background-color var(--transition-speed) ease;
            position: relative;
        }

        .layer-item:hover {
            background-color: var(--light-gray);
        }

        .layer-checkbox {
            margin-right: 10px;
        }

        .layer-label {
            flex-grow: 1;
            cursor: pointer;
        }

        .layer-preview {
            position: absolute;
            left: 100%;
            top: 0;
            width: 150px;
            height: 100px;
            background-color: var(--white);
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            padding: 5px;
            display: none;
            z-index: 999;
            overflow: hidden;
        }

        .layer-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 4px;
        }

        .layer-item:hover .layer-preview {
            display: block;
        }

        .layer-opacity {
            display: flex;
            align-items: center;
            margin-top: 5px;
        }

        .layer-opacity input {
            width: 100%;
            margin: 0 10px;
        }

        .layer-badge {
            display: inline-block;
            padding: 2px 6px;
            background-color: var(--accent2-color);
            color: var(--white);
            font-size: 0.7rem;
            border-radius: 10px;
            margin-left: 5px;
        }

        /* --- Panel de Información --- */
        .info-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 320px;
            max-height: 40vh;
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            z-index: 998;
            overflow: hidden;
            transition: all var(--transition-speed) ease;
            transform: translateY(0);
            opacity: 1;
        }

        .info-panel.collapsed {
            width: 50px;
            height: 50px;
            max-height: 50px;
        }

        .info-panel-header {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: var(--white);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .info-panel-content {
            padding: 15px;
            max-height: calc(40vh - 60px);
            overflow-y: auto;
        }

        .info-panel.collapsed .info-panel-content {
            display: none;
        }

        .feature-table {
            width: 100%;
            border-collapse: collapse;
        }

        .feature-table th {
            background-color: var(--primary-color);
            color: var(--white);
            padding: 8px;
            text-align: left;
        }

        .feature-table td {
            padding: 8px;
            border-bottom: 1px solid var(--light-gray);
        }

        .feature-table tr:last-child td {
            border-bottom: none;
        }

        .info-card {
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 15px;
        }

        .info-card-image {
            height: 150px;
            width: 100%;
            object-fit: cover;
        }

        .info-card-content {
            padding: 15px;
        }

        .info-card-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .info-card-description {
            margin-bottom: 15px;
        }

        .info-card-actions {
            display: flex;
            justify-content: space-between;
        }

        .info-card-button {
            padding: 8px 15px;
            border-radius: 20px;
            border: none;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }

        .info-card-primary {
            background-color: var(--primary-color);
            color: var(--white);
        }

        .info-card-primary:hover {
            background-color: var(--accent-color);
        }

        .info-card-secondary {
            background-color: var(--light-gray);
            color: var(--dark-gray);
        }

        .info-card-secondary:hover {
            background-color: var(--dark-gray);
            color: var(--white);
        }

        /* --- Barra de Herramientas --- */
        .toolbar {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            flex-direction: column;
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            z-index: 998;
            overflow: hidden;
        }

        .tool-button {
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: transparent;
            border: none;
            color: var(--primary-color);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            border-bottom: 1px solid var(--light-gray);
            position: relative;
            overflow: hidden;
        }

        .tool-button:last-child {
            border-bottom: none;
        }

        .tool-button:hover {
            background-color: var(--light-gray);
            color: var(--accent-color);
            transform: scale(1.05);
        }

        .tool-button.active {
            background-color: var(--primary-color);
            color: var(--white);
        }

        .tool-button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }

        .tool-button:focus:not(:active)::after {
            animation: ripple 1s ease-out;
        }

        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 1;
            }
            20% {
                transform: scale(25, 25);
                opacity: 1;
            }
            100% {
                opacity: 0;
                transform: scale(40, 40);
            }
        }

        .tool-tooltip {
            position: absolute;
            left: 60px;
            top: 50%;
            transform: translateY(-50%);
            background-color: var(--dark-gray);
            color: var(--white);
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity var(--transition-speed) ease;
        }

        .tool-button:hover .tool-tooltip {
            opacity: 1;
        }

        /* --- Barra de Búsqueda --- */
        .search-container {
            position: absolute;
            top: 90px;
            left: 50%;
            transform: translateX(-50%);
            width: 400px;
            z-index: 998;
        }

        .search-input {
            width: 100%;
            padding: 12px 45px 12px 20px;
            border: none;
            border-radius: var(--border-radius);
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            font-size: 1rem;
            transition: all var(--transition-speed) ease;
        }

        .search-input:focus {
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
            outline: none;
        }

        .search-button {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--primary-color);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }

        .search-button:hover {
            color: var(--accent-color);
            transform: translateY(-50%) scale(1.1);
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 5px;
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            max-height: 300px;
            overflow-y: auto;
            z-index: 998;
            display: none;
        }

        .search-result-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color var(--transition-speed) ease;
            display: flex;
            align-items: center;
        }

        .search-result-item:hover {
            background-color: var(--light-gray);
        }

        .search-result-icon {
            margin-right: 10px;
            color: var(--primary-color);
        }

        .search-result-popularity {
            margin-left: auto;
            display: flex;
            align-items: center;
        }

        .search-result-star {
            color: var(--sunset-orange);
            font-size: 0.8rem;
            margin-left: 2px;
        }

        /* --- Barra de Progreso de Carga --- */
        .progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background-color: var(--light-gray);
            z-index: 9999;
            display: none;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--ocean-blue));
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-message {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: var(--white);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            z-index: 9999;
            display: none;
        }

        /* --- Onboarding Interactivo --- */
        .onboarding-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            display: none;
        }

        .onboarding-tooltip {
            position: absolute;
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            padding: 20px;
            width: 300px;
            z-index: 10000;
        }

        .onboarding-tooltip::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: var(--white);
            transform: rotate(45deg);
        }

        .onboarding-tooltip.top::before {
            bottom: -10px;
            left: 50%;
            margin-left: -10px;
        }

        .onboarding-tooltip.right::before {
            left: -10px;
            top: 50%;
            margin-top: -10px;
        }

        .onboarding-tooltip.bottom::before {
            top: -10px;
            left: 50%;
            margin-left: -10px;
        }

        .onboarding-tooltip.left::before {
            right: -10px;
            top: 50%;
            margin-top: -10px;
        }

        .onboarding-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .onboarding-content {
            margin-bottom: 15px;
        }

        .onboarding-actions {
            display: flex;
            justify-content: space-between;
        }

        .onboarding-button {
            padding: 8px 15px;
            border-radius: 20px;
            border: none;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }

        .onboarding-skip {
            background-color: transparent;
            color: var(--dark-gray);
        }

        .onboarding-next {
            background-color: var(--primary-color);
            color: var(--white);
        }

        .onboarding-next:hover {
            background-color: var(--accent-color);
        }

        .onboarding-progress {
            display: flex;
            justify-content: center;
            margin-top: 15px;
        }

        .onboarding-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--light-gray);
            margin: 0 4px;
        }

        .onboarding-dot.active {
            background-color: var(--primary-color);
        }

        /* --- Modo de Presentación --- */
        .presentation-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--black);
            z-index: 9999;
            display: none;
        }

        .presentation-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 30px;
            padding: 10px 20px;
            z-index: 10000;
        }

        .presentation-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: transparent;
            border: none;
            color: var(--white);
            font-size: 1.2rem;
            cursor: pointer;
            margin: 0 5px;
            transition: all var(--transition-speed) ease;
        }

        .presentation-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .presentation-button.active {
            background-color: var(--primary-color);
        }

        .presentation-timer {
            display: flex;
            align-items: center;
            color: var(--white);
            margin: 0 15px;
            font-size: 0.9rem;
        }

        /* --- Sistema de Badges/Logros --- */
        .achievement-notification {
            position: fixed;
            top: 80px;
            right: -400px;
            width: 350px;
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            padding: 15px;
            display: flex;
            align-items: center;
            z-index: 9999;
            transition: right var(--transition-speed) ease;
        }

        .achievement-notification.show {
            right: 20px;
        }

        .achievement-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--sunset-orange), var(--sunset-purple));
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 15px;
            color: var(--white);
            font-size: 1.5rem;
        }

        .achievement-content {
            flex-grow: 1;
        }

        .achievement-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .achievement-description {
            font-size: 0.9rem;
            color: var(--dark-gray);
        }

        .achievements-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100%;
            background-color: var(--white);
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            z-index: 9999;
            transition: right var(--transition-speed) ease;
            overflow-y: auto;
        }

        .achievements-panel.show {
            right: 0;
        }

        .achievements-header {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: var(--white);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .achievements-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .achievements-close {
            background: none;
            border: none;
            color: var(--white);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .achievements-content {
            padding: 20px;
        }

        .achievement-category {
            margin-bottom: 25px;
        }

        .achievement-category-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .achievement-items {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .achievement-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .achievement-badge {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 8px;
            position: relative;
        }

        .achievement-badge.unlocked {
            background: linear-gradient(135deg, var(--sunset-orange), var(--sunset-purple));
            color: var(--white);
        }

        .achievement-badge.locked {
            background-color: var(--light-gray);
            color: var(--dark-gray);
        }

        .achievement-badge i {
            font-size: 1.5rem;
        }

        .achievement-badge .badge-count {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            background-color: var(--accent2-color);
            color: var(--white);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .achievement-name {
            font-size: 0.8rem;
            color: var(--dark-gray);
        }

        /* --- Indicador de Carga --- */
        .loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            display: none;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--light-gray);
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- Escala y Norte --- */
        .map-scale {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 998;
        }

        .map-north {
            position: absolute;
            bottom: 80px;
            right: 20px;
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            z-index: 998;
            transition: all var(--transition-speed) ease;
        }

        .map-north:hover {
            transform: scale(1.1);
            background-color: rgba(255, 255, 255, 1);
        }

        /* --- Footer con Degradado --- */
        .main-footer {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: var(--light-gray);
            text-align: center;
            padding: 3rem 0;
            margin-top: 5rem;
            position: relative;
            overflow: hidden;
        }

        .main-footer::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('https://picsum.photos/seed/algarrobo-pattern/1920/300.jpg') no-repeat center center;
            background-size: cover;
            opacity: 0.1;
            z-index: -1;
        }

        .main-footer p {
            margin: 0;
            font-size: 1.1rem;
        }

        .main-footer a {
            color: var(--white);
            font-weight: 600;
        }

        .footer-fact {
            margin-top: 1rem;
            font-style: italic;
            opacity: 0.8;
        }

        /* --- Diseño Responsivo (Mobile) --- */
        @media (max-width: 768px) {
            .main-header .container {
                flex-wrap: wrap;
            }

            .main-nav {
                width: 100%;
                display: none;
            }

            .main-nav.active {
                display: block;
            }

            .main-nav ul {
                flex-direction: column;
                text-align: center;
                margin-top: 1rem;
            }

            .main-nav ul li {
                margin: 10px 0;
            }

            .menu-toggle {
                display: block;
            }

            .layers-panel {
                width: 280px;
                right: 10px;
                top: 10px;
            }

            .info-panel {
                width: 280px;
                left: 10px;
                bottom: 10px;
            }

            .search-container {
                width: 90%;
                top: 70px;
            }

            .toolbar {
                flex-direction: row;
                top: auto;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
            }

            .tool-button {
                border-bottom: none;
                border-right: 1px solid var(--light-gray);
            }

            .tool-button:last-child {
                border-right: none;
            }
            
            /* Ajustes para controles en móvil */
            .leaflet-top {
                top: 60px !important;
            }
            
            .leaflet-right {
                right: 10px !important;
            }

            .hero-title {
                font-size: 2.5rem;
            }

            .hero-subtitle {
                font-size: 1.2rem;
            }

            .breadcrumbs {
                display: none;
            }
        }
    </style>
</head>
<body>

    <!-- ==================== HERO SECTION ==================== -->
    <section class="hero-section" id="hero-section">
        <div class="hero-overlay"></div>
        <div class="hero-content">
            <h1 class="hero-title">
                <span class="typewriter">Geoportal Algarrobo</span>
            </h1>
            <p class="hero-subtitle">Descubre la belleza y los datos geoespaciales de nuestra costa</p>
            <button class="hero-cta" id="explore-map">Explorar el Mapa</button>
        </div>
        <div class="scroll-indicator">
            <i class="fas fa-chevron-down fa-2x"></i>
        </div>
    </section>

    <!-- ==================== HEADER ==================== -->
    <header class="main-header">
        <div class="container">
            <a href="#" class="logo">
                <i class="fas fa-map-marked-alt"></i>
                Geoportal Algarrobo
                <span class="logo-subtitle">Plataforma oficial de mapas y datos territoriales</span>
            </a>
            <nav class="main-nav">
                <ul>
                    <li><a href="#" class="nav-link active">Visor</a></li>
                    <li><a href="#" class="nav-link">Mapas</a></li>
                    <li><a href="#" class="nav-link">Datos</a></li>
                    <li><a href="#" class="nav-link">Aplicaciones</a></li>
                    <li><a href="#" class="nav-link">Acerca de</a></li>
                </ul>
            </nav>
            <div class="menu-toggle">
                <i class="fas fa-bars"></i>
            </div>
        </div>
    </header>

    <!-- ==================== MAPA Y CONTROLES ==================== -->
    <div class="map-container">
        <div id="map"></div>
        
        <!-- Breadcrumbs Visuales -->
        <div class="breadcrumbs">
            <div class="breadcrumb-item">
                <a href="#" class="breadcrumb-link">Inicio</a>
            </div>
            <div class="breadcrumb-item">
                <a href="#" class="breadcrumb-link">Visor</a>
            </div>
            <div class="breadcrumb-item">
                <span class="breadcrumb-current">Algarrobo</span>
            </div>
            <div class="zoom-indicator">
                <i class="fas fa-search-plus"></i>
                <div class="zoom-level">
                    <div class="zoom-fill" id="zoom-fill"></div>
                </div>
            </div>
        </div>
        
        <!-- Barra de Herramientas -->
        <div class="toolbar">
            <button class="tool-button" id="zoom-in" title="Acercar">
                <i class="fas fa-plus"></i>
                <span class="tool-tooltip">Acercar</span>
            </button>
            <button class="tool-button" id="zoom-out" title="Alejar">
                <i class="fas fa-minus"></i>
                <span class="tool-tooltip">Alejar</span>
            </button>
            <button class="tool-button" id="home" title="Vista inicial">
                <i class="fas fa-home"></i>
                <span class="tool-tooltip">Vista inicial</span>
            </button>
            <button class="tool-button" id="measure" title="Medir">
                <i class="fas fa-ruler"></i>
                <span class="tool-tooltip">Medir distancias</span>
            </button>
            <button class="tool-button" id="draw" title="Dibujar">
                <i class="fas fa-draw-polygon"></i>
                <span class="tool-tooltip">Dibujar en el mapa</span>
            </button>
            <button class="tool-button" id="print" title="Imprimir">
                <i class="fas fa-print"></i>
                <span class="tool-tooltip">Imprimir mapa</span>
            </button>
            <button class="tool-button" id="presentation" title="Modo presentación">
                <i class="fas fa-play"></i>
                <span class="tool-tooltip">Modo presentación</span>
            </button>
            <button class="tool-button" id="achievements" title="Logros">
                <i class="fas fa-trophy"></i>
                <span class="tool-tooltip">Ver logros</span>
            </button>
        </div>
        
        <!-- Barra de Búsqueda -->
        <div class="search-container">
            <input type="text" class="search-input" id="search-input" placeholder="Buscar dirección o lugar...">
            <button class="search-button" id="search-button">
                <i class="fas fa-search"></i>
            </button>
            <div class="search-results" id="search-results"></div>
        </div>
        
        <!-- Panel de Control de Capas -->
        <div class="layers-panel" id="layers-panel">
            <div class="panel-header" id="layers-panel-header">
                <div class="panel-title">Capas</div>
                <div class="panel-toggle">
                    <i class="fas fa-chevron-right"></i>
                </div>
            </div>
            <div class="panel-content">
                <!-- Capas Base -->
                <div class="layer-group">
                    <div class="layer-group-title">
                        <i class="fas fa-layer-group"></i>
                        Mapa Base
                    </div>
                    <div class="layer-group-content">
                        <div class="layer-item">
                            <input type="radio" name="base-layer" id="osm" class="layer-checkbox" checked>
                            <label for="osm" class="layer-label">OpenStreetMap</label>
                            <div class="layer-preview">
                                <img src="https://picsum.photos/seed/osm-preview/150/100.jpg" alt="OpenStreetMap Preview">
                            </div>
                        </div>
                        <div class="layer-item">
                            <input type="radio" name="base-layer" id="satellite" class="layer-checkbox">
                            <label for="satellite" class="layer-label">Satélite</label>
                            <div class="layer-preview">
                                <img src="https://picsum.photos/seed/satellite-preview/150/100.jpg" alt="Satellite Preview">
                            </div>
                        </div>
                        <div class="layer-item">
                            <input type="radio" name="base-layer" id="terrain" class="layer-checkbox">
                            <label for="terrain" class="layer-label">Terreno</label>
                            <div class="layer-preview">
                                <img src="https://picsum.photos/seed/terrain-preview/150/100.jpg" alt="Terrain Preview">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Capas Temáticas -->
                <div class="layer-group">
                    <div class="layer-group-title">
                        <i class="fas fa-layer-group"></i>
                        Capas Temáticas
                    </div>
                    <div class="layer-group-content">
                        <div class="layer-item">
                            <input type="checkbox" id="tsunami-points" class="layer-checkbox">
                            <label for="tsunami-points" class="layer-label">Puntos de Encuentro Tsunami</label>
                            <span class="layer-badge">3</span>
                            <div class="layer-preview">
                                <img src="https://picsum.photos/seed/tsunami-points-preview/150/100.jpg" alt="Tsunami Points Preview">
                            </div>
                        </div>
                        <div class="layer-item">
                            <input type="checkbox" id="tsunami-zone" class="layer-checkbox">
                            <label for="tsunami-zone" class="layer-label">Área de Evacuación Tsunami</label>
                            <span class="layer-badge">1</span>
                            <div class="layer-preview">
                                <img src="https://picsum.photos/seed/tsunami-zone-preview/150/100.jpg" alt="Tsunami Zone Preview">
                            </div>
                        </div>
                        <div class="layer-item">
                            <input type="checkbox" id="solar-radiation" class="layer-checkbox">
                            <label for="solar-radiation" class="layer-label">Mediciones Radiación Solar</label>
                            <span class="layer-badge">5</span>
                            <div class="layer-preview">
                                <img src="https://picsum.photos/seed/solar-radiation-preview/150/100.jpg" alt="Solar Radiation Preview">
                            </div>
                        </div>
                        <div class="layer-item">
                            <input type="checkbox" id="wind-measurements" class="layer-checkbox">
                            <label for="wind-measurements" class="layer-label">Mediciones Eólicas</label>
                            <span class="layer-badge">4</span>
                            <div class="layer-preview">
                                <img src="https://picsum.photos/seed/wind-measurements-preview/150/100.jpg" alt="Wind Measurements Preview">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Panel de Información -->
        <div class="info-panel" id="info-panel">
            <div class="info-panel-header" id="info-panel-header">
                <div class="panel-title">Información</div>
                <div class="panel-toggle">
                    <i class="fas fa-chevron-right"></i>
                </div>
            </div>
            <div class="info-panel-content">
                <div id="feature-info">
                    <p>Haz clic en un elemento del mapa para ver su información detallada.</p>
                </div>
            </div>
        </div>
        
        <!-- Indicador de Carga -->
        <div class="loading-indicator" id="loading-indicator">
            <div class="loading-spinner"></div>
        </div>
        
        <!-- Escala y Norte -->
        <div class="map-north">
            <i class="fas fa-location-arrow" style="transform: rotate(0deg);"></i>
        </div>
        <div class="map-scale" id="map-scale"></div>
    </div>

    <!-- ==================== FOOTER ==================== -->
    <footer class="main-footer">
        <div class="container">
            <p>&copy; 2024 Geoportal Algarrobo. Municipalidad de Algarrobo, Chile. Todos los derechos reservados. Desarrollado con <i class="fas fa-heart" style="color: var(--accent2-color);"></i> usando <a href="https://leafletjs.com/" target="_blank">Leaflet</a>.</p>
            <p class="footer-fact" id="footer-fact">¿Sabías que? Algarrobo es conocido como la "Capital de la Vela" de Chile.</p>
        </div>
    </footer>

    <!-- ==================== COMPONENTES ADICIONALES ==================== -->
    
    <!-- Barra de Progreso de Carga -->
    <div class="progress-bar" id="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
    </div>
    
    <div class="progress-message" id="progress-message">
        Cargando mapa...
    </div>
    
    <!-- Onboarding Interactivo -->
    <div class="onboarding-overlay" id="onboarding-overlay">
        <div class="onboarding-tooltip" id="onboarding-tooltip">
            <div class="onboarding-title" id="onboarding-title">Bienvenido al Geoportal</div>
            <div class="onboarding-content" id="onboarding-content">
                Te guiaremos a través de las principales características del geoportal de Algarrobo.
            </div>
            <div class="onboarding-actions">
                <button class="onboarding-button onboarding-skip" id="onboarding-skip">Saltar</button>
                <button class="onboarding-button onboarding-next" id="onboarding-next">Siguiente</button>
            </div>
            <div class="onboarding-progress" id="onboarding-progress">
                <div class="onboarding-dot active"></div>
                <div class="onboarding-dot"></div>
                <div class="onboarding-dot"></div>
                <div class="onboarding-dot"></div>
            </div>
        </div>
    </div>
    
    <!-- Modo de Presentación -->
    <div class="presentation-mode" id="presentation-mode">
        <div id="presentation-map"></div>
        <div class="presentation-controls">
            <button class="presentation-button" id="presentation-prev">
                <i class="fas fa-step-backward"></i>
            </button>
            <button class="presentation-button" id="presentation-play">
                <i class="fas fa-play"></i>
            </button>
            <button class="presentation-button" id="presentation-next">
                <i class="fas fa-step-forward"></i>
            </button>
            <button class="presentation-button" id="presentation-exit">
                <i class="fas fa-times"></i>
            </button>
            <div class="presentation-timer">
                <i class="fas fa-clock"></i>
                <span id="presentation-timer">00:00</span>
            </div>
        </div>
    </div>
    
    <!-- Notificación de Logro -->
    <div class="achievement-notification" id="achievement-notification">
        <div class="achievement-icon">
            <i class="fas fa-trophy"></i>
        </div>
        <div class="achievement-content">
            <div class="achievement-title" id="achievement-title">Nuevo Logro</div>
            <div class="achievement-description" id="achievement-description">Has desbloqueado un nuevo logro</div>
        </div>
    </div>
    
    <!-- Panel de Logros -->
    <div class="achievements-panel" id="achievements-panel">
        <div class="achievements-header">
            <div class="achievements-title">Tus Logros</div>
            <button class="achievements-close" id="achievements-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="achievements-content">
            <div class="achievement-category">
                <div class="achievement-category-title">Exploración</div>
                <div class="achievement-items">
                    <div class="achievement-item">
                        <div class="achievement-badge unlocked">
                            <i class="fas fa-map"></i>
                            <div class="badge-count">1</div>
                        </div>
                        <div class="achievement-name">Primer Paso</div>
                    </div>
                    <div class="achievement-item">
                        <div class="achievement-badge unlocked">
                            <i class="fas fa-compass"></i>
                            <div class="badge-count">5</div>
                        </div>
                        <div class="achievement-name">Explorador</div>
                    </div>
                    <div class="achievement-item">
                        <div class="achievement-badge locked">
                            <i class="fas fa-globe-americas"></i>
                        </div>
                        <div class="achievement-name">Viajero</div>
                    </div>
                </div>
            </div>
            <div class="achievement-category">
                <div class="achievement-category-title">Interacción</div>
                <div class="achievement-items">
                    <div class="achievement-item">
                        <div class="achievement-badge unlocked">
                            <i class="fas fa-mouse-pointer"></i>
                        </div>
                        <div class="achievement-name">Primer Clic</div>
                    </div>
                    <div class="achievement-item">
                        <div class="achievement-badge locked">
                            <i class="fas fa-hand-pointer"></i>
                        </div>
                        <div class="achievement-name">Interactivo</div>
                    </div>
                    <div class="achievement-item">
                        <div class="achievement-badge locked">
                            <i class="fas fa-hand-rock"></i>
                        </div>
                        <div class="achievement-name">Experto</div>
                    </div>
                </div>
            </div>
            <div class="achievement-category">
                <div class="achievement-category-title">Conocimiento</div>
                <div class="achievement-items">
                    <div class="achievement-item">
                        <div class="achievement-badge unlocked">
                            <i class="fas fa-book"></i>
                        </div>
                        <div class="achievement-name">Aprendiz</div>
                    </div>
                    <div class="achievement-item">
                        <div class="achievement-badge locked">
                            <i class="fas fa-graduation-cap"></i>
                        </div>
                        <div class="achievement-name">Estudioso</div>
                    </div>
                    <div class="achievement-item">
                        <div class="achievement-badge locked">
                            <i class="fas fa-brain"></i>
                        </div>
                        <div class="achievement-name">Sabio</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS (Última versión) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
    
    <!-- Leaflet Draw JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    
    <!-- Leaflet Measure JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-measure/3.1.0/leaflet-measure.js"></script>
    
    <!-- Leaflet Search JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-search/3.0.0/leaflet-search.min.js"></script>
    
    <!-- Leaflet Print JS -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet-browser-print@2.0.2/dist/leaflet.browser.print.min.js"></script>
    
    <!-- AOS JS para animaciones -->
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

    <!-- Script para inicializar el mapa y la funcionalidad -->
    <script>
        // --- INICIALIZACIÓN DE AOS ---
        AOS.init({
            duration: 800,
            easing: 'ease-in-out',
            once: true
        });
        
        // --- VARIABLES GLOBALES ---
        let map;
        let presentationMap;
        let measureControl;
        let drawControl;
        let drawnItems;
        let presentationTimer;
        let presentationSeconds = 0;
        let isPresentationPlaying = false;
        let presentationSlides = [];
        let currentSlideIndex = 0;
        
        // --- DATOS DE EJEMPLO ---
        const footerFacts = [
            "¿Sabías que? Algarrobo es conocido como la 'Capital de la Vela' de Chile.",
            "¿Sabías que? El nombre Algarrobo proviene del árbol de algarrobo, común en la zona.",
            "¿Sabías que? Algarrobo cuenta con una de las piscinas más grandes del mundo, la piscina San Alfonso del Mar.",
            "¿Sabías que? La bahía de Algarrobo fue un importante puerto durante la época colonial.",
            "¿Sabías que? Algarrobo es un destino popular para la observación de ballenas entre julio y noviembre."
        ];
        
        // --- FUNCIONES DE UTILIDAD ---
        function showProgressBar(message) {
            const progressBar = document.getElementById('progress-bar');
            const progressFill = document.getElementById('progress-fill');
            const progressMessage = document.getElementById('progress-message');
            
            progressBar.style.display = 'block';
            progressMessage.style.display = 'block';
            progressMessage.textContent = message;
            
            // Simular progreso
            let progress = 0;
            const interval = setInterval(() => {
                progress += 5;
                progressFill.style.width = `${progress}%`;
                
                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        progressBar.style.display = 'none';
                        progressMessage.style.display = 'none';
                        progressFill.style.width = '0%';
                    }, 500);
                }
            }, 100);
        }
        
        function showAchievement(title, description) {
            const notification = document.getElementById('achievement-notification');
            const achievementTitle = document.getElementById('achievement-title');
            const achievementDescription = document.getElementById('achievement-description');
            
            achievementTitle.textContent = title;
            achievementDescription.textContent = description;
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }
        
        function updateZoomIndicator() {
            const zoomFill = document.getElementById('zoom-fill');
            const zoomLevel = map.getZoom();
            const maxZoom = 19;
            const percentage = (zoomLevel / maxZoom) * 100;
            zoomFill.style.width = `${percentage}%`;
        }
        
        function changeFooterFact() {
            const footerFact = document.getElementById('footer-fact');
            const randomIndex = Math.floor(Math.random() * footerFacts.length);
            footerFact.textContent = footerFacts[randomIndex];
        }
        
        function createRipple(event, button) {
            const ripple = document.createElement('span');
            ripple.classList.add('ripple');
            
            const rect = button.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            const x = event.clientX - rect.left - size / 2;
            const y = event.clientY - rect.top - size / 2;
            
            ripple.style.width = ripple.style.height = size + 'px';
            ripple.style.left = x + 'px';
            ripple.style.top = y + 'px';
            
            button.appendChild(ripple);
            
            setTimeout(() => {
                ripple.remove();
            }, 600);
        }
        
        function isNightTime() {
            const hour = new Date().getHours();
            return hour < 6 || hour >= 20;
        }
        
        function applyDayNightTheme() {
            if (isNightTime()) {
                document.documentElement.style.setProperty('--primary-color', '#1a237e');
                document.documentElement.style.setProperty('--secondary-color', '#283593');
                document.documentElement.style.setProperty('--accent-color', '#3949ab');
            } else {
                document.documentElement.style.setProperty('--primary-color', '#007B5E');
                document.documentElement.style.setProperty('--secondary-color', '#006644');
                document.documentElement.style.setProperty('--accent-color', '#005C4A');
            }
        }
        
        // --- INICIALIZACIÓN DEL MAPA ---
        function initializeMap() {
            showProgressBar("Cargando mapa de Algarrobo...");
            
            // Coordenadas iniciales y nivel de zoom (Algarrobo, Chile)
            map = L.map('map').setView([-33.3549, -71.6559], 13);

            // Capas base
            const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            });

            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
                maxZoom: 19
            });

            const terrainLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)',
                maxZoom: 17
            });

            // Añadir la capa base inicial
            osmLayer.addTo(map);

            // Grupo de capas base
            const baseLayers = {
                "OpenStreetMap": osmLayer,
                "Satélite": satelliteLayer,
                "Terreno": terrainLayer
            };

            // Grupo de capas temáticas (vacío inicialmente)
            const thematicLayers = {};

            // --- CONTROL DE CAPAS ---
            const layerControl = L.control.layers(baseLayers, thematicLayers, {
                position: 'topright'
            }).addTo(map);

            // --- DATOS DE EJEMPLO PARA CAPAS TEMÁTICAS SOLICITADAS ---
            
            // Puntos de Encuentro Tsunami
            const tsunamiPointsLayer = L.layerGroup();
            const tsunamiPoints = [
                { name: "Punto de Encuentro - Colegio Algarrobo", position: [-33.3560, -71.6530], popularity: 5 },
                { name: "Punto de Encuentro - Plaza de Armas", position: [-33.3563, -71.6529], popularity: 4 },
                { name: "Punto de Encuentro - Estadio Municipal", position: [-33.3520, -71.6580], popularity: 3 }
            ];
            
            tsunamiPoints.forEach(point => {
                const pointMarker = L.marker(point.position, {
                    icon: L.divIcon({
                        html: '<i class="fas fa-map-marker-alt" style="color: #C70039; font-size: 24px;"></i>',
                        iconSize: [24, 24],
                        className: 'tsunami-point-icon'
                    })
                }).bindPopup(`
                    <div class="info-card">
                        <img src="https://picsum.photos/seed/${point.name.replace(/\s+/g, '-').toLowerCase()}/300/150.jpg" alt="${point.name}" class="info-card-image">
                        <div class="info-card-content">
                            <h3 class="info-card-title">${point.name}</h3>
                            <p class="info-card-description">Punto de encuentro designado en caso de alerta de tsunami. Este lugar ha sido evaluado como seguro y accesible para la comunidad.</p>
                            <div class="info-card-actions">
                                <button class="info-card-button info-card-primary">Más información</button>
                                <button class="info-card-button info-card-secondary">Compartir</button>
                            </div>
                        </div>
                    </div>
                `);
                tsunamiPointsLayer.addLayer(pointMarker);
            });

            // Área de Evacuación Tsunami
            const tsunamiZoneLayer = L.layerGroup();
            const tsunamiZoneBounds = [
                [-33.3450, -71.6400],
                [-33.3450, -71.6350],
                [-33.3650, -71.6350],
                [-33.3650, -71.6400]
            ];
            const tsunamiZonePolygon = L.polygon(tsunamiZoneBounds, {
                color: '#FF9800',
                weight: 3,
                fillOpacity: 0.3
            }).bindPopup(`
                <div class="info-card">
                    <img src="https://picsum.photos/seed/tsunami-evacuation-zone/300/150.jpg" alt="Zona de Evacuación" class="info-card-image">
                    <div class="info-card-content">
                        <h3 class="info-card-title">Zona de Evacuación por Tsunami</h3>
                        <p class="info-card-description">Área designada como segura ante una alerta de tsunami. En caso de emergencia, diríjase a esta zona siguiendo las rutas de evacuación señalizadas.</p>
                        <div class="info-card-actions">
                            <button class="info-card-button info-card-primary">Ver rutas</button>
                            <button class="info-card-button info-card-secondary">Más información</button>
                        </div>
                    </div>
                </div>
            `);
            tsunamiZoneLayer.addLayer(tsunamiZonePolygon);

            // Mediciones Radiación Solar
            const solarRadiationLayer = L.layerGroup();
            const solarMeasurements = [
                { position: [-33.3500, -71.6500], radiation: "5.2 kWh/m²", date: "2024-01-15" },
                { position: [-33.3550, -71.6550], radiation: "5.5 kWh/m²", date: "2024-01-15" },
                { position: [-33.3600, -71.6600], radiation: "5.1 kWh/m²", date: "2024-01-15" },
                { position: [-33.3480, -71.6520], radiation: "5.3 kWh/m²", date: "2024-01-14" },
                { position: [-33.3570, -71.6580], radiation: "5.0 kWh/m²", date: "2024-01-14" }
            ];
            
            solarMeasurements.forEach(measurement => {
                const measurementMarker = L.marker(measurement.position, {
                    icon: L.divIcon({
                        html: '<i class="fas fa-sun" style="color: #FFC107; font-size: 20px;"></i>',
                        iconSize: [20, 20],
                        className: 'solar-icon'
                    })
                }).bindPopup(`
                    <div class="info-card">
                        <img src="https://picsum.photos/seed/solar-radiation-${measurement.position[0]}-${measurement.position[1]}/300/150.jpg" alt="Medición de Radiación Solar" class="info-card-image">
                        <div class="info-card-content">
                            <h3 class="info-card-title">Medición de Radiación Solar</h3>
                            <p class="info-card-description">Radiación: ${measurement.radiation}<br>Fecha: ${measurement.date}</p>
                            <div class="info-card-actions">
                                <button class="info-card-button info-card-primary">Ver historial</button>
                                <button class="info-card-button info-card-secondary">Descargar datos</button>
                            </div>
                        </div>
                    </div>
                `);
                solarRadiationLayer.addLayer(measurementMarker);
            });

            // Mediciones Eólicas
            const windMeasurementsLayer = L.layerGroup();
            const windMeasurements = [
                { position: [-33.3450, -71.6450], speed: "12 km/h", direction: "SO", date: "2024-01-15" },
                { position: [-33.3520, -71.6520], speed: "15 km/h", direction: "O", date: "2024-01-15" },
                { position: [-33.3580, -71.6580], speed: "10 km/h", direction: "S", date: "2024-01-15" },
                { position: [-33.3500, -71.6550], speed: "13 km/h", direction: "SO", date: "2024-01-14" }
            ];
            
            windMeasurements.forEach(measurement => {
                const measurementMarker = L.marker(measurement.position, {
                    icon: L.divIcon({
                        html: '<i class="fas fa-wind" style="color: #03A9F4; font-size: 20px;"></i>',
                        iconSize: [20, 20],
                        className: 'wind-icon'
                    })
                }).bindPopup(`
                    <div class="info-card">
                        <img src="https://picsum.photos/seed/wind-measurement-${measurement.position[0]}-${measurement.position[1]}/300/150.jpg" alt="Medición Eólica" class="info-card-image">
                        <div class="info-card-content">
                            <h3 class="info-card-title">Medición Eólica</h3>
                            <p class="info-card-description">Velocidad: ${measurement.speed}<br>Dirección: ${measurement.direction}<br>Fecha: ${measurement.date}</p>
                            <div class="info-card-actions">
                                <button class="info-card-button info-card-primary">Ver historial</button>
                                <button class="info-card-button info-card-secondary">Descargar datos</button>
                            </div>
                        </div>
                    </div>
                `);
                windMeasurementsLayer.addLayer(measurementMarker);
            });
            
            // --- MANEJO DE CAPAS TEMÁTICAS ---
            document.getElementById('tsunami-points').addEventListener('change', function() {
                if (this.checked) {
                    map.addLayer(tsunamiPointsLayer);
                    thematicLayers['Puntos de Encuentro Tsunami'] = tsunamiPointsLayer;
                    showAchievement("Explorador de Seguridad", "Has activado la capa de puntos de encuentro tsunami");
                } else {
                    map.removeLayer(tsunamiPointsLayer);
                    delete thematicLayers['Puntos de Encuentro Tsunami'];
                }
            });

            document.getElementById('tsunami-zone').addEventListener('change', function() {
                if (this.checked) {
                    map.addLayer(tsunamiZoneLayer);
                    thematicLayers['Área de Evacuación Tsunami'] = tsunamiZonePolygon;
                    showAchievement("Conocedor de Zonas", "Has activado la zona de evacuación tsunami");
                } else {
                    map.removeLayer(tsunamiZoneLayer);
                    delete thematicLayers['Área de Evacuación Tsunami'];
                }
            });

            document.getElementById('solar-radiation').addEventListener('change', function() {
                if (this.checked) {
                    map.addLayer(solarRadiationLayer);
                    thematicLayers['Mediciones Radiación Solar'] = solarRadiationLayer;
                    showAchievement("Investigador Solar", "Has activado las mediciones de radiación solar");
                } else {
                    map.removeLayer(solarRadiationLayer);
                    delete thematicLayers['Mediciones Radiación Solar'];
                }
            });

            document.getElementById('wind-measurements').addEventListener('change', function() {
                if (this.checked) {
                    map.addLayer(windMeasurementsLayer);
                    thematicLayers['Mediciones Eólicas'] = windMeasurementsLayer;
                    showAchievement("Explorador Eólico", "Has activado las mediciones eólicas");
                } else {
                    map.removeLayer(windMeasurementsLayer);
                    delete thematicLayers['Mediciones Eólicas'];
                }
            });
            
            // --- EVENTOS DEL MAPA ---
            map.on('zoomend', updateZoomIndicator);
            
            map.on('click', function(e) {
                const featureInfo = document.getElementById('feature-info');
                
                // Verificar si se hizo clic en una capa
                let clickedLayer = false;
                
                // Iterar sobre todas las capas temáticas
                Object.values(thematicLayers).forEach(layerGroup => {
                    layerGroup.eachLayer(layer => {
                        if (layer instanceof L.Marker || layer instanceof L.Polygon || layer instanceof L.Polyline) {
                            // Para polígonos y polilíneas
                            if (layer instanceof L.Polygon || layer instanceof L.Polyline) {
                                if (layer.getBounds().contains(e.latlng)) {
                                    clickedLayer = true;
                                    layer.openPopup();
                                }
                            }
                            // Para marcadores
                            else if (layer instanceof L.Marker) {
                                const markerLatLng = layer.getLatLng();
                                const distance = e.latlng.distanceTo(markerLatLng);
                                if (distance < 100) { // 100 metros de tolerancia
                                    clickedLayer = true;
                                    layer.openPopup();
                                }
                            }
                        }
                    });
                });
                
                // Si no se hizo clic en ninguna capa, mostrar información de coordenadas
                if (!clickedLayer) {
                    featureInfo.innerHTML = `
                        <div class="info-card">
                            <div class="info-card-content">
                                <h3 class="info-card-title">Información de Ubicación</h3>
                                <table class="feature-table">
                                    <tr>
                                        <th>Propiedad</th>
                                        <th>Valor</th>
                                    </tr>
                                    <tr>
                                        <td>Latitud</td>
                                        <td>${e.latlng.lat.toFixed(6)}</td>
                                    </tr>
                                    <tr>
                                        <td>Longitud</td>
                                        <td>${e.latlng.lng.toFixed(6)}</td>
                                    </tr>
                                    <tr>
                                        <td>Zoom</td>
                                        <td>${map.getZoom()}</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    `;
                }
            });
            
            // --- ESCALA Y ORIENTACIÓN ---
            L.control.scale({
                position: 'bottomright',
                metric: true,
                imperial: false
            }).addTo(map);
            
            // Actualizar la orientación del norte al mover el mapa
            map.on('move', function() {
                const northArrow = document.querySelector('.map-north i');
                const bearing = map.getBearing();
                northArrow.style.transform = `rotate(${-bearing}deg)`;
            });
            
            // --- PREPARAR SLIDES PARA MODO PRESENTACIÓN ---
            presentationSlides = [
                {
                    center: [-33.3549, -71.6559],
                    zoom: 13,
                    title: "Bienvenido a Algarrobo",
                    description: "Una hermosa ciudad costera en la Región de Valparaíso, Chile"
                },
                {
                    center: [-33.3560, -71.6530],
                    zoom: 16,
                    title: "Puntos de Encuentro Tsunami",
                    description: "Zonas seguras designadas en caso de emergencia"
                },
                {
                    center: [-33.3550, -71.6375],
                    zoom: 15,
                    title: "Zona de Evacuación",
                    description: "Área de seguridad ante alerta de tsunami"
                },
                {
                    center: [-33.3500, -71.6500],
                    zoom: 16,
                    title: "Mediciones Ambientales",
                    description: "Monitoreo de radiación solar y condiciones eólicas"
                }
            ];
            
            // --- INICIALIZAR INDICADOR DE ZOOM ---
            updateZoomIndicator();
            
            // --- OCULTAR INDICADOR DE CARGA ---
            setTimeout(() => {
                document.getElementById('loading-indicator').style.display = 'none';
            }, 1000);
        }
        
        // --- INICIALIZACIÓN DEL MODO PRESENTACIÓN ---
        function initializePresentationMode() {
            if (presentationMap) {
                presentationMap.remove();
            }
            
            presentationMap = L.map('presentation-map').setView(presentationSlides[0].center, presentationSlides[0].zoom);
            
            // Añadir capa base al mapa de presentación
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }).addTo(presentationMap);
            
            // Añadir marcadores para cada slide
            presentationSlides.forEach((slide, index) => {
                L.marker(slide.center).addTo(presentationMap)
                    .bindPopup(`<b>${slide.title}</b><br>${slide.description}`);
            });
            
            // Mostrar el primer slide
            showPresentationSlide(0);
        }
        
        function showPresentationSlide(index) {
            if (index < 0 || index >= presentationSlides.length) return;
            
            currentSlideIndex = index;
            const slide = presentationSlides[index];
            
            // Animar al siguiente slide
            presentationMap.flyTo(slide.center, slide.zoom, {
                duration: 2
            });
            
            // Actualizar botones de navegación
            document.getElementById('presentation-prev').classList.toggle('active', index > 0);
            document.getElementById('presentation-next').classList.toggle('active', index < presentationSlides.length - 1);
        }
        
        function startPresentationTimer() {
            if (presentationTimer) clearInterval(presentationTimer);
            
            presentationTimer = setInterval(() => {
                presentationSeconds++;
                const minutes = Math.floor(presentationSeconds / 60);
                const seconds = presentationSeconds % 60;
                document.getElementById('presentation-timer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // Avanzar al siguiente slide cada 10 segundos
                if (presentationSeconds % 10 === 0) {
                    nextPresentationSlide();
                }
            }, 1000);
        }
        
        function stopPresentationTimer() {
            if (presentationTimer) {
                clearInterval(presentationTimer);
                presentationTimer = null;
            }
        }
        
        function nextPresentationSlide() {
            const nextIndex = (currentSlideIndex + 1) % presentationSlides.length;
            showPresentationSlide(nextIndex);
        }
        
        function prevPresentationSlide() {
            const prevIndex = (currentSlideIndex - 1 + presentationSlides.length) % presentationSlides.length;
            showPresentationSlide(prevIndex);
        }
        
        // --- INICIALIZACIÓN DE ONBOARDING ---
        function initializeOnboarding() {
            const overlay = document.getElementById('onboarding-overlay');
            const tooltip = document.getElementById('onboarding-tooltip');
            const title = document.getElementById('onboarding-title');
            const content = document.getElementById('onboarding-content');
            const nextBtn = document.getElementById('onboarding-next');
            const skipBtn = document.getElementById('onboarding-skip');
            const progressDots = document.querySelectorAll('.onboarding-dot');
            
            let currentStep = 0;
            
            const steps = [
                {
                    title: "Bienvenido al Geoportal",
                    content: "Te guiaremos a través de las principales características del geoportal de Algarrobo.",
                    position: { top: '50%', left: '50%', transform: 'translate(-50%, -50%)' },
                    class: 'top'
                },
                {
                    title: "Explora el Mapa",
                    content: "Usa los controles de zoom y navegación para explorar el mapa de Algarrobo.",
                    position: { top: '200px', left: '80px' },
                    class: 'right'
                },
                {
                    title: "Capas Temáticas",
                    content: "Activa y desactiva capas para visualizar diferente información en el mapa.",
                    position: { top: '200px', right: '80px', left: 'auto' },
                    class: 'left'
                },
                {
                    title: "Búsqueda de Lugares",
                    content: "Busca direcciones, puntos de interés y lugares específicos en la barra de búsqueda.",
                    position: { top: '120px', left: '50%', transform: 'translateX(-50%)' },
                    class: 'bottom'
                }
            ];
            
            function showStep(stepIndex) {
                if (stepIndex < 0 || stepIndex >= steps.length) {
                    overlay.style.display = 'none';
                    return;
                }
                
                currentStep = stepIndex;
                const step = steps[stepIndex];
                
                title.textContent = step.title;
                content.textContent = step.content;
                
                // Posicionar el tooltip
                Object.keys(step.position).forEach(key => {
                    tooltip.style[key] = step.position[key];
                });
                
                // Actualizar clase de posición
                tooltip.className = 'onboarding-tooltip';
                tooltip.classList.add(step.class);
                
                // Actualizar dots de progreso
                progressDots.forEach((dot, index) => {
                    dot.classList.toggle('active', index === stepIndex);
                });
                
                // Actualizar botón siguiente
                nextBtn.textContent = stepIndex === steps.length - 1 ? 'Finalizar' : 'Siguiente';
                
                // Mostrar overlay
                overlay.style.display = 'block';
            }
            
            nextBtn.addEventListener('click', () => {
                if (currentStep === steps.length - 1) {
                    overlay.style.display = 'none';
                    showAchievement("Tutorial Completado", "Has completado el tutorial del geoportal");
                } else {
                    showStep(currentStep + 1);
                }
            });
            
            skipBtn.addEventListener('click', () => {
                overlay.style.display = 'none';
            });
            
            // Mostrar el primer paso
            showStep(0);
        }
        
        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', function() {
            // Aplicar tema día/noche
            applyDayNightTheme();
            
            // Inicializar mapa
            initializeMap();
            
            // Cambiar hecho del footer cada 30 segundos
            setInterval(changeFooterFact, 30000);
            
            // Efecto ripple en botones
            document.querySelectorAll('.hero-cta, .tool-button, .info-card-button').forEach(button => {
                button.addEventListener('click', function(e) {
                    createRipple(e, this);
                });
            });
            
            // Botón de explorar mapa
            document.getElementById('explore-map').addEventListener('click', function() {
                document.getElementById('hero-section').scrollIntoView({ behavior: 'smooth' });
                showAchievement("Explorador", "Has comenzado a explorar el geoportal");
            });
            
            // Scroll indicator
            document.querySelector('.scroll-indicator').addEventListener('click', function() {
                document.getElementById('hero-section').scrollIntoView({ behavior: 'smooth' });
            });
            
            // --- FUNCIONALIDAD DEL PANEL DE CAPAS ---
            const layersPanel = document.getElementById('layers-panel');
            const layersPanelHeader = document.getElementById('layers-panel-header');
            const infoPanel = document.getElementById('info-panel');
            const infoPanelHeader = document.getElementById('info-panel-header');